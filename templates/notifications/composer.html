{% extends 'layouts/dashboard_base.html' %}
{% load static %}

{% block title %}إرسال إشعار - S-ACM{% endblock %}
{% block page_title %}إنشاء إشعار جديد{% endblock %}

{% block dashboard_content %}
<div class="row justify-content-center">
    <div class="col-lg-9">
        <div class="card" style="border:none;border-radius:var(--radius,12px);box-shadow:var(--shadow-sm,0 1px 3px rgba(0,0,0,0.06));">
            <div class="card-body p-4">
                <h5 class="fw-bold mb-4">
                    <i class="bi bi-pencil-square me-2" style="color:var(--primary,#6366f1);"></i>
                    إنشاء إشعار جديد
                </h5>

                <form method="post" novalidate id="composer-form">
                    {% csrf_token %}

                    <!-- عنوان الإشعار -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="{{ form.title.id_for_label }}">
                            <i class="bi bi-type me-1"></i>{{ form.title.label }}
                        </label>
                        {{ form.title }}
                        {% if form.title.errors %}<div class="text-danger small mt-1">{{ form.title.errors.0 }}</div>{% endif %}
                    </div>

                    <!-- محتوى الإشعار -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="{{ form.body.id_for_label }}">
                            <i class="bi bi-text-paragraph me-1"></i>{{ form.body.label }}
                        </label>
                        {{ form.body }}
                        {% if form.body.errors %}<div class="text-danger small mt-1">{{ form.body.errors.0 }}</div>{% endif %}
                    </div>

                    <!-- نوع الإشعار والأولوية -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold" for="{{ form.notification_type.id_for_label }}">
                                <i class="bi bi-tag me-1"></i>{{ form.notification_type.label }}
                            </label>
                            {{ form.notification_type }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold" for="{{ form.priority.id_for_label }}">
                                <i class="bi bi-exclamation-diamond me-1"></i>{{ form.priority.label }}
                            </label>
                            {{ form.priority }}
                        </div>
                    </div>

                    <hr class="my-4">
                    <h6 class="fw-bold mb-3"><i class="bi bi-people me-2" style="color:var(--secondary,#0ea5e9);"></i>المستلمون</h6>

                    <!-- نوع الاستهداف -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="{{ form.target_type.id_for_label }}">{{ form.target_type.label }}</label>
                        {{ form.target_type }}
                    </div>

                    <!-- فلاتر ديناميكية -->
                    <div id="targeting-details">
                        <!-- المقرر -->
                        <div class="mb-3" id="course-field" style="display:none;">
                            <label class="form-label fw-semibold" for="{{ form.course.id_for_label }}">{{ form.course.label }}</label>
                            {{ form.course }}
                            {% if form.course.errors %}<div class="text-danger small mt-1">{{ form.course.errors.0 }}</div>{% endif %}
                        </div>

                        <!-- التخصص -->
                        <div class="mb-3" id="major-field" style="display:none;">
                            <label class="form-label fw-semibold" for="{{ form.major.id_for_label }}">{{ form.major.label }}</label>
                            {{ form.major }}
                            {% if form.major.errors %}<div class="text-danger small mt-1">{{ form.major.errors.0 }}</div>{% endif %}
                        </div>

                        <!-- المستوى (يتحدث عبر HTMX) -->
                        <div class="mb-3" id="level-field" style="display:none;">
                            <label class="form-label fw-semibold" for="{{ form.level.id_for_label }}">{{ form.level.label }}</label>
                            <div id="level-select">
                                {{ form.level }}
                            </div>
                        </div>

                        <!-- طالب محدد -->
                        <div class="mb-3" id="specific-student-field" style="display:none;">
                            <label class="form-label fw-semibold">بحث عن طالب</label>
                            <input type="text" class="form-control mb-2" placeholder="ابحث بالاسم أو الرقم الأكاديمي..."
                                   hx-get="{% url 'notifications:htmx_search_students' %}"
                                   hx-trigger="keyup changed delay:300ms"
                                   hx-target="#student-results"
                                   name="q">
                            <div id="student-results" class="list-group"></div>
                            {{ form.specific_user_id }}
                            <div id="selected-student" class="mt-2"></div>
                        </div>
                    </div>

                    <!-- عدد المستلمين (HTMX) -->
                    <div id="recipients-count" class="mb-3"
                         hx-get="{% url 'notifications:htmx_students_count' %}"
                         hx-trigger="change from:#id_target_type, change from:#id_course, change from:#id_major, change from:#id_level delay:300ms"
                         hx-include="#composer-form"
                         hx-swap="innerHTML">
                    </div>

                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send me-1"></i>إرسال الإشعار
                        </button>
                        <a href="{% url 'notifications:sent' %}" class="btn btn-outline-secondary">إلغاء</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// === Dynamic Targeting Fields ===
document.addEventListener('DOMContentLoaded', function() {
    const targetType = document.getElementById('id_target_type');
    const courseField = document.getElementById('course-field');
    const majorField = document.getElementById('major-field');
    const levelField = document.getElementById('level-field');
    const specificField = document.getElementById('specific-student-field');

    function updateFields() {
        const value = targetType.value;
        courseField.style.display = 'none';
        majorField.style.display = 'none';
        levelField.style.display = 'none';
        specificField.style.display = 'none';

        if (value === 'course_students') {
            courseField.style.display = 'block';
        } else if (value === 'major_students') {
            majorField.style.display = 'block';
            levelField.style.display = 'block';
        } else if (value === 'specific_student') {
            specificField.style.display = 'block';
        }
    }

    targetType.addEventListener('change', updateFields);
    updateFields();

    // HTMX: Cascading Dropdown for Major -> Level
    const majorSelect = document.getElementById('id_major');
    if (majorSelect) {
        majorSelect.setAttribute('hx-get', '{% url "notifications:htmx_levels" %}');
        majorSelect.setAttribute('hx-target', '#level-select');
        majorSelect.setAttribute('hx-trigger', 'change');
        majorSelect.setAttribute('hx-swap', 'innerHTML');
        htmx.process(majorSelect);
    }
});

// Student search selection
function selectStudent(id, name) {
    document.getElementById('id_specific_user_id').value = id;
    document.getElementById('selected-student').innerHTML =
        '<div class="alert alert-success py-2 px-3 d-flex align-items-center gap-2">' +
        '<i class="bi bi-person-check"></i>' +
        '<span>تم اختيار: <strong>' + name + '</strong></span>' +
        '<button type="button" class="btn-close ms-auto" onclick="clearStudent()"></button></div>';
    document.getElementById('student-results').innerHTML = '';
}

function clearStudent() {
    document.getElementById('id_specific_user_id').value = '';
    document.getElementById('selected-student').innerHTML = '';
}
</script>
{% endblock %}
