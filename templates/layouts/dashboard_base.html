{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="S-ACM - نظام إدارة المحتوى الأكاديمي الذكي">
    <title>{% block title %}S-ACM{% endblock %}</title>

    <!-- Viewport with safe area -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">

    <!-- PWA Meta -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#6366f1">

    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Tajawal Font (CDN fallback for local @font-face) -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <!-- Bootstrap 5 RTL -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- S-ACM Design System -->
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <!-- S-ACM Mobile App Experience -->
    <link href="{% static 'css/mobile-app.css' %}" rel="stylesheet">

    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- ==========================================
         SIDEBAR OVERLAY (Mobile)
         ========================================== -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- ==========================================
         DESKTOP SIDEBAR (Glassmorphism + Collapsible)
         ========================================== -->
    <nav class="sidebar" id="sidebar" role="navigation" aria-label="القائمة الرئيسية">
        <!-- Collapse Toggle Button -->
        <button class="sidebar-collapse-btn" id="sidebarCollapseBtn" title="طي/توسيع القائمة" aria-label="طي القائمة" type="button">
            <i class="bi bi-chevron-left"></i>
        </button>

        <!-- Brand -->
        <div class="sidebar-brand">
            <div class="sidebar-brand-icon">
                <i class="bi bi-mortarboard-fill"></i>
            </div>
            <div class="sidebar-brand-text">
                <h4>S-ACM</h4>
                <small>{% if is_instructor %}مركز القيادة{% elif is_student %}بوابة التعلم{% else %}لوحة التحكم{% endif %}</small>
            </div>
        </div>

        <!-- Navigation -->
        <div class="sidebar-nav" id="sidebarNav">
            {% block sidebar_nav %}
            {% if is_instructor %}
            <!-- Instructor Navigation -->
            <div class="sidebar-section-title">الرئيسية</div>
            <div class="nav-item">
                <a class="nav-link {% if active_page == 'dashboard' %}active{% endif %}" href="{% url 'instructor:dashboard' %}" title="لوحة التحكم">
                    <i class="bi bi-speedometer2"></i>
                    <span class="link-text">لوحة التحكم</span>
                </a>
            </div>
            <div class="nav-item">
                <a class="nav-link {% if active_page == 'courses' %}active{% endif %}" href="{% url 'instructor:course_list' %}" title="مقرراتي">
                    <i class="bi bi-book"></i>
                    <span class="link-text">مقرراتي</span>
                </a>
            </div>

            <div class="sidebar-section-title">الأدوات</div>
            <div class="nav-item">
                <a class="nav-link {% if active_page == 'ai_hub' %}active{% endif %}" href="{% url 'instructor:ai_hub' %}" title="مركز AI">
                    <i class="bi bi-robot"></i>
                    <span class="link-text">مركز AI</span>
                </a>
            </div>
            <div class="nav-item">
                <a class="nav-link {% if active_page == 'reports' %}active{% endif %}" href="{% url 'instructor:reports' %}" title="التقارير">
                    <i class="bi bi-bar-chart-line"></i>
                    <span class="link-text">التقارير</span>
                </a>
            </div>
            <div class="nav-item">
                <a class="nav-link {% if active_page == 'upload' %}active{% endif %}" href="{% url 'instructor:file_upload' %}" title="رفع ملف">
                    <i class="bi bi-cloud-upload"></i>
                    <span class="link-text">رفع ملف</span>
                </a>
            </div>
            <div class="nav-item">
                <a class="nav-link {% if active_page == 'trash' %}active{% endif %}" href="{% url 'instructor:trash_list' %}" title="سلة المهملات">
                    <i class="bi bi-trash3"></i>
                    <span class="link-text text-truncate">سلة المهملات</span>
                    {% if trash_count %}<span class="sidebar-badge">{{ trash_count }}</span>{% endif %}
                </a>
            </div>

            <div class="sidebar-section-title">التواصل</div>
            <div class="nav-item">
                <a class="nav-link {% if active_page == 'notifications' %}active{% endif %}" href="{% url 'notifications:management' %}" title="إدارة الإشعارات">
                    <i class="bi bi-bell"></i>
                    <span class="link-text text-truncate">إدارة الإشعارات</span>
                    {% if unread_count %}<span class="sidebar-badge">{{ unread_count }}</span>{% endif %}
                </a>
            </div>

            <div class="sidebar-section-title">النظام</div>
            <div class="nav-item">
                <a class="nav-link {% if active_page == 'settings' %}active{% endif %}" href="{% url 'instructor:settings' %}" title="الإعدادات">
                    <i class="bi bi-gear"></i>
                    <span class="link-text">الإعدادات</span>
                </a>
            </div>

            {% elif is_student %}
            <!-- Student Navigation -->
            <div class="sidebar-section-title">الرئيسية</div>
            <div class="nav-item">
                <a class="nav-link {% if active_page == 'dashboard' %}active{% endif %}" href="{% url 'student:dashboard' %}" title="لوحة التحكم">
                    <i class="bi bi-speedometer2"></i>
                    <span class="link-text">لوحة التحكم</span>
                </a>
            </div>
            <div class="nav-item">
                <a class="nav-link {% if active_page == 'courses' %}active{% endif %}" href="{% url 'student:course_list' %}" title="مقرراتي">
                    <i class="bi bi-book"></i>
                    <span class="link-text">مقرراتي</span>
                </a>
            </div>

            <div class="sidebar-section-title">الذكاء الاصطناعي</div>
            <div class="nav-item">
                <a class="nav-link {% if active_page == 'ai_center' %}active{% endif %}" href="{% url 'student:ai_center' %}" title="مركز AI">
                    <i class="bi bi-stars"></i>
                    <span class="link-text">مركز AI</span>
                </a>
            </div>
            <div class="nav-item">
                <a class="nav-link" href="{% url 'ai_features:usage_stats' %}" title="إحصائيات AI">
                    <i class="bi bi-bar-chart"></i>
                    <span class="link-text">إحصائيات AI</span>
                </a>
            </div>

            <div class="sidebar-section-title">التواصل</div>
            <div class="nav-item">
                <a class="nav-link {% if active_page == 'notifications' %}active{% endif %}" href="{% url 'notifications:management' %}" title="إدارة الإشعارات">
                    <i class="bi bi-bell"></i>
                    <span class="link-text text-truncate">إدارة الإشعارات</span>
                    {% if unread_count %}<span class="sidebar-badge">{{ unread_count }}</span>{% endif %}
                </a>
            </div>

            <div class="sidebar-section-title">النظام</div>
            <div class="nav-item">
                <a class="nav-link {% if active_page == 'settings' %}active{% endif %}" href="{% url 'student:settings' %}" title="الإعدادات">
                    <i class="bi bi-gear"></i>
                    <span class="link-text">الإعدادات</span>
                </a>
            </div>
            {% endif %}
            {% endblock %}
        </div>

        <!-- Sidebar Footer - User Info -->
        <div class="sidebar-footer">
            <div class="sidebar-user">
                <div class="avatar-circle">
                    {{ request.user.full_name|slice:":1"|upper }}
                </div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name text-truncate">{{ request.user.full_name|truncatechars:16 }}</div>
                    <div class="sidebar-user-role">{{ user_role|default:"مستخدم" }}</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- ==========================================
         MAIN CONTENT WRAPPER
         ========================================== -->
    <div class="main-wrapper" id="mainWrapper">
        <!-- Top Navbar -->
        <header class="top-navbar" id="topNavbar">
            <div class="d-flex align-items-center gap-3 min-w-0">
                <!-- Mobile Menu Toggle (hamburger) -->
                <button class="btn-icon mobile-toggle" id="mobileMenuToggle" type="button" aria-label="فتح القائمة">
                    <i class="bi bi-list"></i>
                </button>
                <h6 class="page-title mb-0 text-truncate">{% block page_title %}لوحة التحكم{% endblock %}</h6>
            </div>
            <div class="nav-actions">
                <!-- Notifications Dropdown -->
                <div class="dropdown">
                    <button class="btn-icon position-relative" data-bs-toggle="dropdown" aria-label="الإشعارات">
                        <i class="bi bi-bell"></i>
                        {% if unread_count and unread_count > 0 %}
                        <span class="notification-dot">{{ unread_count }}</span>
                        {% endif %}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-lg" style="min-width:300px;max-width:340px;">
                        <li>
                            <div class="dropdown-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 fw-bold">الإشعارات</h6>
                                {% if unread_count > 0 %}
                                <span class="badge bg-primary rounded-pill">{{ unread_count }} جديد</span>
                                {% endif %}
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        {% if recent_notifications %}
                            {% for nr in recent_notifications %}
                            <li>
                                <a class="dropdown-item py-2" href="{% url 'notifications:detail' nr.notification.pk %}">
                                    <div class="d-flex gap-2 align-items-start">
                                        <i class="bi bi-circle-fill text-primary flex-shrink-0" style="font-size:0.4rem;margin-top:7px;"></i>
                                        <div class="min-w-0">
                                            <div class="fw-semibold small text-truncate">{{ nr.notification.title|truncatechars:38 }}</div>
                                            <div class="text-muted" style="font-size:0.7rem;">{{ nr.notification.created_at|timesince }} مضت</div>
                                        </div>
                                    </div>
                                </a>
                            </li>
                            {% endfor %}
                        {% else %}
                            <li><p class="text-muted text-center py-3 mb-0 small"><i class="bi bi-bell-slash me-1"></i>لا توجد إشعارات جديدة</p></li>
                        {% endif %}
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <div class="d-flex justify-content-between px-3 py-1">
                                <a class="dropdown-item text-center small p-0 text-primary" href="{% url 'notifications:management' %}">عرض الكل</a>
                                {% if unread_count > 0 %}
                                <form method="post" action="{% url 'notifications:mark_all_read' %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-link text-muted small p-0" style="font-size:0.72rem;">تحديد الكل كمقروء</button>
                                </form>
                                {% endif %}
                            </div>
                        </li>
                    </ul>
                </div>

                <!-- User Menu -->
                <div class="dropdown">
                    <button class="d-flex align-items-center gap-2 btn btn-link text-decoration-none p-0" data-bs-toggle="dropdown" aria-label="قائمة المستخدم">
                        <div class="avatar-circle avatar-sm">{{ request.user.full_name|slice:":1"|upper }}</div>
                        <span class="d-none d-md-inline small fw-semibold text-truncate" style="max-width:100px;color:var(--text-primary);">{{ request.user.full_name|truncatechars:12 }}</span>
                        <i class="bi bi-chevron-down d-none d-md-inline" style="font-size:0.6rem;color:var(--text-secondary);"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-lg">
                        <li>
                            <div class="dropdown-header">
                                <strong class="text-truncate d-block">{{ request.user.full_name }}</strong>
                                <small class="text-muted">{{ user_role }}</small>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{% url 'accounts:profile' %}"><i class="bi bi-person me-2"></i>الملف الشخصي</a></li>
                        <li><a class="dropdown-item" href="{% url 'accounts:change_password' %}"><i class="bi bi-key me-2"></i>تغيير كلمة المرور</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="{% url 'accounts:logout' %}"><i class="bi bi-box-arrow-right me-2"></i>تسجيل الخروج</a></li>
                    </ul>
                </div>
            </div>
        </header>

        <!-- Toast Messages -->
        {% if messages %}
        <div class="toast-container" id="toastContainer">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
                {% if message.tags == 'success' %}<i class="bi bi-check-circle-fill me-2"></i>
                {% elif message.tags == 'error' or message.tags == 'danger' %}<i class="bi bi-exclamation-triangle-fill me-2"></i>
                {% elif message.tags == 'warning' %}<i class="bi bi-exclamation-circle-fill me-2"></i>
                {% else %}<i class="bi bi-info-circle-fill me-2"></i>{% endif %}
                <span class="text-truncate">{{ message }}</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Page Content -->
        <main class="page-content" id="pageContent">
            {% block breadcrumb %}{% endblock %}
            {% block dashboard_content %}{% endblock %}
        </main>

        <!-- Footer (Desktop only) -->
        <footer class="dashboard-footer">
            <small>&copy; 2026 S-ACM Enterprise - نظام إدارة المحتوى الأكاديمي الذكي</small>
        </footer>
    </div>

    <!-- ==========================================
         MOBILE BOTTOM NAVIGATION BAR
         ========================================== -->
    <nav class="mobile-bottom-nav" id="mobileBottomNav" role="navigation" aria-label="التنقل الرئيسي">
        {% if is_instructor %}
        <a href="{% url 'instructor:dashboard' %}" class="bottom-nav-item {% if active_page == 'dashboard' %}active{% endif %}" data-nav="dashboard">
            <i class="bi {% if active_page == 'dashboard' %}bi-speedometer2{% else %}bi-speedometer2{% endif %}"></i>
            <span>الرئيسية</span>
        </a>
        <a href="{% url 'instructor:course_list' %}" class="bottom-nav-item {% if active_page == 'courses' %}active{% endif %}" data-nav="courses">
            <i class="bi bi-book"></i>
            <span>المقررات</span>
        </a>
        <a href="{% url 'notifications:management' %}" class="bottom-nav-item {% if active_page == 'notifications' %}active{% endif %}" data-nav="notifications">
            <i class="bi bi-bell"></i>
            <span>الإشعارات</span>
            {% if unread_count and unread_count > 0 %}
            <span class="bottom-nav-badge">{{ unread_count }}</span>
            {% endif %}
        </a>
        <a href="{% url 'accounts:profile' %}" class="bottom-nav-item {% if active_page == 'profile' %}active{% endif %}" data-nav="profile">
            <i class="bi bi-person"></i>
            <span>حسابي</span>
        </a>
        <button class="bottom-nav-item" id="moreMenuBtn" type="button" data-nav="more" aria-label="المزيد">
            <i class="bi bi-grid-3x3-gap"></i>
            <span>المزيد</span>
        </button>

        {% elif is_student %}
        <a href="{% url 'student:dashboard' %}" class="bottom-nav-item {% if active_page == 'dashboard' %}active{% endif %}" data-nav="dashboard">
            <i class="bi bi-speedometer2"></i>
            <span>الرئيسية</span>
        </a>
        <a href="{% url 'student:course_list' %}" class="bottom-nav-item {% if active_page == 'courses' %}active{% endif %}" data-nav="courses">
            <i class="bi bi-book"></i>
            <span>المقررات</span>
        </a>
        <a href="{% url 'notifications:management' %}" class="bottom-nav-item {% if active_page == 'notifications' %}active{% endif %}" data-nav="notifications">
            <i class="bi bi-bell"></i>
            <span>الإشعارات</span>
            {% if unread_count and unread_count > 0 %}
            <span class="bottom-nav-badge">{{ unread_count }}</span>
            {% endif %}
        </a>
        <a href="{% url 'accounts:profile' %}" class="bottom-nav-item {% if active_page == 'profile' %}active{% endif %}" data-nav="profile">
            <i class="bi bi-person"></i>
            <span>حسابي</span>
        </a>
        <button class="bottom-nav-item" id="moreMenuBtn" type="button" data-nav="more" aria-label="المزيد">
            <i class="bi bi-grid-3x3-gap"></i>
            <span>المزيد</span>
        </button>
        {% endif %}
    </nav>

    <!-- ==========================================
         MOBILE DRAWER (More Menu)
         ========================================== -->
    <div class="mobile-drawer-overlay" id="mobileDrawerOverlay"></div>
    <div class="mobile-drawer" id="mobileDrawer" role="dialog" aria-label="قائمة إضافية">
        <div class="drawer-handle" aria-hidden="true"></div>
        <div class="drawer-header">
            <h3>المزيد</h3>
            <button class="drawer-close-btn" id="drawerCloseBtn" type="button" aria-label="إغلاق">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="drawer-body">
            <div class="drawer-grid">
                {% if is_instructor %}
                <a href="{% url 'instructor:ai_hub' %}" class="drawer-item {% if active_page == 'ai_hub' %}active{% endif %}">
                    <div class="drawer-item-icon"><i class="bi bi-robot"></i></div>
                    <span class="text-truncate">مركز AI</span>
                </a>
                <a href="{% url 'instructor:reports' %}" class="drawer-item {% if active_page == 'reports' %}active{% endif %}">
                    <div class="drawer-item-icon"><i class="bi bi-bar-chart-line"></i></div>
                    <span class="text-truncate">التقارير</span>
                </a>
                <a href="{% url 'instructor:file_upload' %}" class="drawer-item">
                    <div class="drawer-item-icon"><i class="bi bi-cloud-upload"></i></div>
                    <span class="text-truncate">رفع ملف</span>
                </a>
                <a href="{% url 'instructor:trash_list' %}" class="drawer-item {% if active_page == 'trash' %}active{% endif %}">
                    <div class="drawer-item-icon"><i class="bi bi-trash3"></i></div>
                    <span class="text-truncate">المهملات</span>
                </a>
                <a href="{% url 'instructor:settings' %}" class="drawer-item {% if active_page == 'settings' %}active{% endif %}">
                    <div class="drawer-item-icon"><i class="bi bi-gear"></i></div>
                    <span class="text-truncate">الإعدادات</span>
                </a>
                <a href="{% url 'accounts:logout' %}" class="drawer-item drawer-item-danger">
                    <div class="drawer-item-icon"><i class="bi bi-box-arrow-right"></i></div>
                    <span class="text-truncate">خروج</span>
                </a>
                {% elif is_student %}
                <a href="{% url 'student:ai_center' %}" class="drawer-item {% if active_page == 'ai_center' %}active{% endif %}">
                    <div class="drawer-item-icon"><i class="bi bi-stars"></i></div>
                    <span class="text-truncate">مركز AI</span>
                </a>
                <a href="{% url 'ai_features:usage_stats' %}" class="drawer-item">
                    <div class="drawer-item-icon"><i class="bi bi-bar-chart"></i></div>
                    <span class="text-truncate">إحصائيات AI</span>
                </a>
                <a href="{% url 'student:settings' %}" class="drawer-item {% if active_page == 'settings' %}active{% endif %}">
                    <div class="drawer-item-icon"><i class="bi bi-gear"></i></div>
                    <span class="text-truncate">الإعدادات</span>
                </a>
                <a href="{% url 'accounts:change_password' %}" class="drawer-item">
                    <div class="drawer-item-icon"><i class="bi bi-key"></i></div>
                    <span class="text-truncate">كلمة المرور</span>
                </a>
                <a href="{% url 'accounts:logout' %}" class="drawer-item drawer-item-danger">
                    <div class="drawer-item-icon"><i class="bi bi-box-arrow-right"></i></div>
                    <span class="text-truncate">خروج</span>
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ==========================================
         SCRIPTS
         ========================================== -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="{% static 'js/main.js' %}"></script>
    {% block extra_js %}{% endblock %}
</body>
</html>
